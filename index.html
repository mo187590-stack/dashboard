<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Entry Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{background:#f6f7fb}
    .card-kpi{border:0;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .kpi-value{font-size:30px;font-weight:800}
    .kpi-title{color:#6c757d;font-size:13px}
    .small-muted{color:#6c757d;font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .table thead th{white-space:nowrap}
    .badge-soft{background:#eef2ff;color:#1e40af}
  </style>
</head>

<body class="p-4">
  <div class="container">

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <div>
        <h5 class="m-0">Dashboard â€” Ù‚Ø³Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
        <div class="small-muted">Ø§Ù„Ù…ØµØ¯Ø±: Google Sheets (Apps Script API)</div>
      </div>
      <div class="small-muted">
        Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="last_update">--</span>
      </div>
    </div>

    <div id="file_warning" class="alert alert-danger d-none">
      âŒ Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø© Ø¨Ø·Ø±ÙŠÙ‚Ø© <b>file://</b> ÙˆØ¯Ù‡ Ø¨ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ (CORS).
      <br>
      âœ… Ø§ÙØªØ­ÙŠÙ‡Ø§ Ù…Ù† Ø±Ø§Ø¨Ø· GitHub Pages Ø£Ùˆ Ù…Ù† Live Server.
    </div>

    <!-- Dept KPIs -->
    <div class="row g-3">
      <div class="col-md-3">
        <div class="card card-kpi p-3">
          <div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
          <div class="kpi-value" id="dept_total_invoices">--</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-kpi p-3">
          <div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
          <div class="kpi-value" id="dept_total_items">--</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-kpi p-3">
          <div class="kpi-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
          <div class="kpi-value" id="dept_total_errors">--</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card card-kpi p-3">
          <div class="kpi-title">Errors / 100 Invoice</div>
          <div class="kpi-value"><span id="dept_err_100_inv">--</span></div>
          <div class="small-muted">+ Errors / 1000 Items: <b id="dept_err_1000_items">--</b></div>
        </div>
      </div>
    </div>

    <!-- Status + Charts -->
    <div class="row g-3 mt-1">
      <div class="col-md-7">
        <div class="card card-kpi p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="kpi-title">API</div>
              <div class="mono small-muted" id="api_url_show">--</div>
              <div class="small-muted mt-1" id="api_status">Ø§Ù„Ø­Ø§Ù„Ø©: --</div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" id="btn_open_api">Ø§ÙØªØ­ Ø§Ù„Ù€ API</button>
              <button class="btn btn-primary btn-sm" id="btn_refresh">ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
          <div class="alert alert-warning mt-3 d-none" id="error_box"></div>
        </div>

        <div class="card card-kpi p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="kpi-title">ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØ±ÙŠÙ‚ (8 Ø£ÙØ±Ø§Ø¯)</div>
            <span class="badge badge-soft">Sort: Score â†“</span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Invoices</th>
                  <th>Items</th>
                  <th>Errors</th>
                  <th>Err/100 Inv</th>
                  <th>Err/1000 Items</th>
                  <th>Score</th>
                </tr>
              </thead>
              <tbody id="team_tbody">
                <tr><td colspan="8" class="text-muted">--</td></tr>
              </tbody>
            </table>
          </div>
          <div class="small-muted mt-2">
            * Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Tab: KPIs ÙÙŠ Google Sheet.
          </div>
        </div>
      </div>

      <div class="col-md-5">
        <div class="card card-kpi p-3">
          <div class="kpi-title mb-2">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</div>
          <canvas id="errors_donut" height="220"></canvas>
          <div class="small-muted mt-2" id="errors_hint">--</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // âœ… API URL (Ø§Ù„Ù„ÙŠÙ†Ùƒ Ø§Ù„Ù„ÙŠ Ø¨Ø¹ØªÙŠÙ‡)
    const API_URL = "https://script.google.com/macros/s/AKfycbwbZCCuz4OlOhmdaombIybEy1hS-fhX27daSmhYG3urM5zPOQj_yC3U4hR0_fP6F6M/exec";

    const $ = (id) => document.getElementById(id);

    function showError(msg) {
      const box = $("error_box");
      box.classList.remove("d-none");
      box.textContent = msg;
    }
    function hideError() {
      const box = $("error_box");
      box.classList.add("d-none");
      box.textContent = "";
    }

    function toNumber(x) {
      const n = Number(String(x ?? "").replace(/,/g, "").trim());
      return isNaN(n) ? 0 : n;
    }
    function fmtInt(x) { return toNumber(x).toLocaleString("en-US"); }
    function fmt2(x) { return toNumber(x).toFixed(2); }
    function fmt1(x) { return toNumber(x).toFixed(1); }

    let donutChart = null;

    function setDeptKPIs(dept) {
      // Ù…ÙØ§ØªÙŠØ­ dept Ø¬Ø§ÙŠØ© Ù…Ù† labels ÙÙŠ KPIs tab
      // Total Invoices / Total Items / Total Errors ... Ø¥Ù„Ø®
      $("dept_total_invoices").textContent = fmtInt(dept["Total Invoices"] ?? 0);
      $("dept_total_items").textContent = fmtInt(dept["Total Items"] ?? 0);
      $("dept_total_errors").textContent = fmtInt(dept["Total Errors"] ?? 0);
      $("dept_err_100_inv").textContent = fmt2(dept["Errors per 100 Invoices"] ?? 0);
      $("dept_err_1000_items").textContent = fmt2(dept["Errors per 1000 Items"] ?? 0);
    }

    function buildTeamTable(team) {
      const tbody = $("team_tbody");
      tbody.innerHTML = "";

      // Normalize expected keys (from KPIs headers in sheet)
      const rows = (team || []).map(r => ({
        emp_id: r.emp_id,
        emp_name: r.emp_name,
        invoices: toNumber(r.invoices),
        items: toNumber(r.items),
        errors: toNumber(r.errors),
        err100: toNumber(r.errors_per_100_invoices),
        err1000: toNumber(r.errors_per_1000_items),
        score: toNumber(r.final_score)
      }));

      rows.sort((a,b) => b.score - a.score);

      if (rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
        return;
      }

      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");

        // simple color indicator based on error rates
        const qualityBadge =
          (r.err100 <= 2 && r.err1000 <= 2) ? "âœ…" :
          (r.err100 <= 5 && r.err1000 <= 5) ? "ğŸŸ¡" : "ğŸ”´";

        tr.innerHTML = `
          <td>${idx+1}</td>
          <td><b>${r.emp_name || r.emp_id}</b> <span class="small-muted">${qualityBadge}</span></td>
          <td>${fmtInt(r.invoices)}</td>
          <td>${fmtInt(r.items)}</td>
          <td>${fmtInt(r.errors)}</td>
          <td>${fmt2(r.err100)}</td>
          <td>${fmt2(r.err1000)}</td>
          <td><b>${fmt1(r.score)}</b></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function buildErrorsDonut(errorsByType) {
      const list = (errorsByType || []).filter(x => (x && x.error_type));

      if (list.length === 0) {
        $("errors_hint").textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Tab Errors.";
        if (donutChart) {
          donutChart.data.labels = [];
          donutChart.data.datasets[0].data = [];
          donutChart.update();
        }
        return;
      }

      const labels = list.map(x => x.error_type);
      const data = list.map(x => toNumber(x.count));

      $("errors_hint").textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹: ${labels.length} â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: ${data.reduce((a,b)=>a+b,0)}`;

      const ctx = $("errors_donut");
      if (!donutChart) {
        donutChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels,
            datasets: [{ data, borderWidth: 0 }]
          },
          options: { plugins: { legend: { position: "right" } }, cutout: "70%" }
        });
      } else {
        donutChart.data.labels = labels;
        donutChart.data.datasets[0].data = data;
        donutChart.update();
      }
    }

    async function loadData() {
      try {
        if (window.location.protocol === "file:") {
          $("file_warning").classList.remove("d-none");
          $("api_status").textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø© file:// (Ù„Ø§Ø²Ù… GitHub Pages Ø£Ùˆ Live Server)";
          return;
        } else {
          $("file_warning").classList.add("d-none");
        }

        hideError();
        $("api_status").textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        const res = await fetch(API_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const payload = await res.json();

        // API-level error
        if (payload && payload.error) {
          $("api_status").textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: API Ø±Ø¬Ù‘Ø¹ Ø®Ø·Ø£";
          showError("API Error: " + payload.error + (payload.available_sheets ? (" | Sheets: " + payload.available_sheets) : ""));
          return;
        }

        $("api_status").textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªØµÙ„ âœ…";
        setDeptKPIs(payload.department || {});
        buildTeamTable(payload.team || []);
        buildErrorsDonut(payload.errors_by_type || []);

        $("last_update").textContent = new Date().toLocaleString("ar-EG");
      } catch (err) {
        $("api_status").textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ";
        showError("Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„: " + err.message + " | ØªØ£ÙƒØ¯ÙŠ Ø¥Ù† Web App Access = AnyoneØŒ ÙˆØ§Ù„Ù„ÙŠÙ†Ùƒ ÙŠÙØªØ­ JSON.");
      }
    }

    // Buttons
    $("api_url_show").textContent = API_URL;
    $("btn_open_api").addEventListener("click", () => window.open(API_URL, "_blank"));
    $("btn_refresh").addEventListener("click", loadData);

    // Start + auto refresh
    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
